#!/usr/bin/env bash
# Parakeet transcription server â€” keeps the model loaded in memory.
#
# Install:  make parakeet
# Usage:
#   backends/parakeet-server start   # start the server (loads model)
#   backends/parakeet-server stop    # stop the server
#   TALKTYPE_CMD="backends/parakeet-server transcribe" talktype

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

# Source user config so env vars are available even when invoked directly.
TALKTYPE_CONFIG="${TALKTYPE_CONFIG:-${XDG_CONFIG_HOME:-$HOME/.config}/talktype/config}"
# shellcheck disable=SC1090
[ -f "$TALKTYPE_CONFIG" ] && source "$TALKTYPE_CONFIG"

VENV="$SCRIPT_DIR/.parakeet-venv"
SOCK="${XDG_RUNTIME_DIR:-/tmp}/parakeet.sock"
PIDFILE="${XDG_RUNTIME_DIR:-/tmp}/parakeet-server.pid"

case "${1:-}" in
    start)
        if [ -f "$PIDFILE" ] && kill -0 "$(cat "$PIDFILE")" 2>/dev/null; then
            echo "Already running (PID $(cat "$PIDFILE"))"
            exit 0
        fi
        if [ ! -x "$VENV/bin/python3" ]; then
            echo "Parakeet backend not installed. Run: make parakeet" >&2
            exit 1
        fi
        rm -f "$PIDFILE" "$SOCK"
        echo "Starting parakeet server (loading model)..."
        "$VENV/bin/python3" "$SCRIPT_DIR/parakeet-daemon.py" "$SOCK" &
        PID=$!
        disown "$PID"
        echo "$PID" > "$PIDFILE"
        for _ in $(seq 1 60); do
            [ -S "$SOCK" ] && break
            sleep 1
        done
        if [ -S "$SOCK" ]; then
            echo "Ready (PID $PID)"
        else
            echo "Failed to start" >&2
            exit 1
        fi
        ;;
    stop)
        if [ -f "$PIDFILE" ]; then
            kill "$(cat "$PIDFILE")" 2>/dev/null || true
            rm -f "$PIDFILE" "$SOCK"
            echo "Stopped"
        else
            echo "Not running"
        fi
        ;;
    transcribe)
        if [ -S "$SOCK" ] && [ -f "$PIDFILE" ] && ! kill -0 "$(cat "$PIDFILE")" 2>/dev/null; then
            rm -f "$PIDFILE" "$SOCK"
        fi
        if [ ! -S "$SOCK" ]; then
            "$0" start >&2 || exit 1
        fi
        echo "$2" | socat -t 120 -T 120 - UNIX-CONNECT:"$SOCK"
        ;;
    *)
        echo "Usage: parakeet-server {start|stop|transcribe <audio.wav>}" >&2
        exit 1
        ;;
esac
