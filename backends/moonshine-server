#!/usr/bin/env bash
# Moonshine transcription server â€” keeps the model loaded in memory.
#
# Install:  make moonshine
# Usage:
#   backends/moonshine-server start   # start (loads model)
#   backends/moonshine-server stop    # stop
#   TALKTYPE_CMD="backends/moonshine-server transcribe" talktype

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
VENV="$SCRIPT_DIR/.moonshine-venv"
SOCK="${XDG_RUNTIME_DIR:-/tmp}/moonshine.sock"
PIDFILE="${XDG_RUNTIME_DIR:-/tmp}/moonshine-server.pid"
MODEL="${MOONSHINE_MODEL:-UsefulSensors/moonshine-base}"

case "${1:-}" in
    start)
        if [ -f "$PIDFILE" ] && kill -0 "$(cat "$PIDFILE")" 2>/dev/null; then
            echo "Already running (PID $(cat "$PIDFILE"))"
            exit 0
        fi
        if [ ! -x "$VENV/bin/python3" ]; then
            echo "Moonshine backend not installed. Run: make moonshine" >&2
            exit 1
        fi
        rm -f "$PIDFILE" "$SOCK"
        echo "Starting moonshine server (loading $MODEL)..."
        "$VENV/bin/python3" "$SCRIPT_DIR/moonshine-daemon.py" "$SOCK" "$MODEL" &
        PID=$!
        disown "$PID"
        echo "$PID" > "$PIDFILE"
        for i in $(seq 1 30); do
            [ -S "$SOCK" ] && break
            sleep 1
        done
        if [ -S "$SOCK" ]; then
            echo "Ready (PID $PID)"
        else
            echo "Failed to start" >&2
            exit 1
        fi
        ;;
    stop)
        if [ -f "$PIDFILE" ]; then
            kill "$(cat "$PIDFILE")" 2>/dev/null || true
            rm -f "$PIDFILE" "$SOCK"
            echo "Stopped"
        else
            echo "Not running"
        fi
        ;;
    transcribe)
        if [ ! -S "$SOCK" ]; then
            "$0" start >&2 || exit 1
        fi
        echo "$2" | socat - UNIX-CONNECT:"$SOCK"
        ;;
    *)
        echo "Usage: moonshine-server {start|stop|transcribe <audio.wav>}" >&2
        exit 1
        ;;
esac
