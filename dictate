#!/usr/bin/env bash
#
# dictate — push-to-talk speech-to-text for Wayland
#
# Bind to a keyboard shortcut. Press once to start recording,
# press again to stop, transcribe, and type the text wherever
# your cursor is.
#
# Transcription is pluggable: set DICTATE_CMD to any command that
# takes a WAV file path as its last argument and prints text to stdout.
#
# Requires: ydotool, pw-record (PipeWire)
#
set -euo pipefail

DICTATE_DIR="${DICTATE_DIR:-${XDG_RUNTIME_DIR:-/tmp}/whisper-dictate}"
PIDFILE="$DICTATE_DIR/rec.pid"
AUDIOFILE="$DICTATE_DIR/rec.wav"

mkdir -p "$DICTATE_DIR"

# ── Default transcription command (faster-whisper) ──
# Override with DICTATE_CMD to use any transcriber, e.g.:
#   DICTATE_CMD="whisper-cpp -m /path/to/model.bin -f" dictate
#   DICTATE_CMD="vosk-transcriber --input" dictate
#   DICTATE_CMD="my-custom-script" dictate
# The audio file path is appended as the last argument.
if [ -z "${DICTATE_CMD:-}" ]; then
    SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
    VENV_DIR="${DICTATE_VENV:-$SCRIPT_DIR/.venv}"
    WHISPER_MODEL="${WHISPER_MODEL:-base}"
    WHISPER_LANG="${WHISPER_LANG:-en}"
    WHISPER_DEVICE="${WHISPER_DEVICE:-cuda}"
    WHISPER_COMPUTE="${WHISPER_COMPUTE:-float16}"

    DICTATE_CMD="$VENV_DIR/bin/python3 $SCRIPT_DIR/transcribe $WHISPER_MODEL $WHISPER_LANG $WHISPER_DEVICE $WHISPER_COMPUTE"
fi

# ── Check core dependencies ──
check_deps() {
    local missing=()
    command -v ydotool    &>/dev/null || missing+=(ydotool)
    command -v pw-record  &>/dev/null || missing+=(pipewire)
    command -v notify-send &>/dev/null || missing+=(libnotify-bin)

    if [ ${#missing[@]} -gt 0 ]; then
        echo "Missing: ${missing[*]}" >&2
        notify-send -h string:x-canonical-private-synchronous:dictate -t 3000 -i dialog-error "Dictation" "Missing: ${missing[*]}" 2>/dev/null || true
        exit 1
    fi
}

check_deps

# ── If currently recording → stop, transcribe, type ──
if [ -f "$PIDFILE" ]; then
    PID=$(cat "$PIDFILE")
    kill "$PID" 2>/dev/null || true
    wait "$PID" 2>/dev/null || true
    rm -f "$PIDFILE"

    # Run the transcription command with the audio file as last arg
    TEXT=$($DICTATE_CMD "$AUDIOFILE")

    rm -f "$AUDIOFILE"

    if [ -z "$TEXT" ]; then
        notify-send -h string:x-canonical-private-synchronous:dictate -t 1500 -i dialog-warning "Dictation" "No speech detected" 2>/dev/null || true
        exit 0
    fi

    # Type text at cursor via ydotool (works on any Wayland compositor)
    ydotool type -- "$TEXT"

# ── Otherwise → start recording ──
else
    # Use ffmpeg to record with a 1-second pre-roll buffer, so speech
    # that starts immediately on keypress is captured.
    if command -v ffmpeg &>/dev/null; then
        ffmpeg -loglevel quiet -f pulse -i default \
            -ac 1 -ar 16000 -f wav "$AUDIOFILE" &>/dev/null &
    else
        pw-record --format=s16 --rate=16000 --channels=1 "$AUDIOFILE" &>/dev/null &
    fi
    PID=$!
    disown "$PID"
    echo "$PID" > "$PIDFILE"
    notify-send -h string:x-canonical-private-synchronous:dictate -t 1500 -i audio-input-microphone "Dictation" "Listening..." 2>/dev/null || true
fi
